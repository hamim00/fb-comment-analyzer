{% set k = data.kpis or {} %}
{% set tc = k.total_comments or 0 %}
{% set avg = k.avg_reactions_per_comment or 0 %}
{% set pos = k.positivity_ratio or 0 %}

{# safe access to sentiment counts #}
{% set sent = (data.sentiment if data and data.sentiment is defined else {}) %}
{% set svals = (sent['values'] if sent and sent['values'] is defined else []) %}
{% set neg = (svals[1] if svals|length > 1 else 0) %}

{% set hi_p75 = (extras.thresholds.high_engagement if extras and extras.thresholds is defined else 0) %}
{% set qcount = (extras.question_bank|length if extras and extras.question_bank is defined else 0) %}
{% set pareto = (extras.pareto_top10_pct if extras and extras.pareto_top10_pct is defined else 0) %}

<div class="tc-wrap dense"><!-- default = Compact (dense). Toggle to cozy via switch -->
  <div class="tc-header">
    <div>
      <h1>Top Comments</h1>
      <p>Quick actions, reply helper, and the full sentiment table.</p>
    </div>
    <div class="density">
      <span>Density</span>
      <button id="compactBtn" class="chip on">Compact</button>
      <button id="cozyBtn" class="chip">Cozy</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-row">
    <div class="kpi"><div class="label">TOTAL</div><div class="val">{{ tc|abbr }}</div></div>
    <div class="kpi"><div class="label">AVG REACTS</div><div class="val">{{ avg }}</div></div>
    <div class="kpi"><div class="label">POSITIVITY</div><div class="val">{{ pos }}%</div></div>
    <div class="kpi"><div class="label">NEGATIVES</div><div class="val">{{ neg }}</div></div>
    <div class="kpi"><div class="label">QUESTIONS</div><div class="val">{{ qcount }}</div></div>
    <div class="kpi"><div class="label">HIGH-ENG (p75)</div><div class="val">{{ hi_p75|round(1) }}</div></div>
    <div class="kpi"><div class="label">PARETO (Top 10)</div><div class="val">{{ pareto }}%</div></div>
  </div>

  <!-- Helper band -->
  <div class="helper-row">
    <div class="panel">
      <div class="panel-head"><span>Reply Queue</span></div>
      <div class="panel-body">
        {% if extras and extras.reply_queue and extras.reply_queue|length %}
          <ul class="mini-list">
            {% for r in extras.reply_queue %}
              <li class="mini-item">
                <span class="avatar">U</span>
                <span class="text clamp2">{{ r.text }}</span>
                <span class="chip chip-eng">eng {{ r.eng }}</span>
                <button class="btn-xxs" data-reply="{{ r.text|e }}" onclick="openReplyModal(this)">Reply</button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty">Nothing critical <span class="muted">üõ°Ô∏è</span></div>
        {% endif %}
      </div>
    </div>
    <div class="panel">
      <div class="panel-head"><span>Question Bank</span></div>
      <div class="panel-body">
        {% if extras and extras.question_bank and extras.question_bank|length %}
          <ul class="mini-list">
            {% for r in extras.question_bank %}
              <li class="mini-item">
                <span class="avatar">?</span>
                <span class="text clamp2">{{ r.text }}</span>
                <span class="chip chip-eng">eng {{ r.eng }}</span>
                <button class="btn-xxs" data-reply="{{ r.text|e }}" onclick="openReplyModal(this)">Reply</button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty">No open questions.</div>
        {% endif %}
      </div>
    </div>
    <div class="panel">
      <div class="panel-head"><span>Influential Commenters</span></div>
      <div class="panel-body">
        {% if extras and extras.influencers and extras.influencers|length %}
          <div class="badges">
            {% for u in extras.influencers %}
              <span class="chip">{{ u.user }} ¬∑ {{ u.comments }} comments ¬∑ {{ u.avg_reacts }} avg</span>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty">Auto-detected heavy engagers appear here.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- 2√ó2 grid -->
  <div class="four-grid">
    <!-- Top Reacted -->
    <div class="block">
      <div class="block-head">
        <h3>Top Reacted</h3>
        <div class="sorts">
          <button class="chip sort on" data-target="#list-reacted" data-show="react">Reactions</button>
          <button class="chip sort"    data-target="#list-reacted" data-show="eng">Eng</button>
          <button class="chip sort"    data-target="#list-reacted" data-show="time">Newest</button>
        </div>
      </div>
      <div id="list-reacted" class="card-list show-react">
        {% for r in (data.top_reacted or []) %}
          <div class="card">
            <span class="avatar">U</span>
            <div class="text clamp2">{{ r.text }}</div>
            <div class="meta">
              <span class="chip chip-react">reactions {{ r.react }}</span>
              <span class="chip chip-eng">eng {{ r.eng }}</span>
              <span class="chip chip-time">{{ loop.index }}</span>
              <button class="btn-xxs" data-reply="{{ r.text|e }}" onclick="openReplyModal(this)">Reply</button>
            </div>
          </div>
        {% else %}
          <div class="empty inset">No items for current filters.</div>
        {% endfor %}
      </div>
    </div>

    <!-- Top Engaged -->
    <div class="block">
      <div class="block-head">
        <h3>Top Engaged</h3>
        <div class="sorts">
          <button class="chip sort"    data-target="#list-engaged" data-show="react">Reactions</button>
          <button class="chip sort on" data-target="#list-engaged" data-show="eng">Eng</button>
          <button class="chip sort"    data-target="#list-engaged" data-show="time">Newest</button>
        </div>
      </div>
      <div id="list-engaged" class="card-list show-eng">
        {% for r in (data.top_engaged or []) %}
          <div class="card">
            <span class="avatar">U</span>
            <div class="text clamp2">{{ r.text }}</div>
            <div class="meta">
              <span class="chip chip-react">reactions {{ r.react }}</span>
              <span class="chip chip-eng">eng {{ r.eng }}</span>
              <span class="chip chip-time">{{ loop.index }}</span>
              <button class="btn-xxs" data-reply="{{ r.text|e }}" onclick="openReplyModal(this)">Reply</button>
            </div>
          </div>
        {% else %}
          <div class="empty inset">No items for current filters.</div>
        {% endfor %}
      </div>
    </div>

    <!-- Top Loved -->
    <div class="block">
      <div class="block-head">
        <h3>Top Loved</h3>
        <div class="sorts">
          <button class="chip sort on" data-target="#list-loved" data-show="love">Love</button>
        </div>
      </div>
      <div id="list-loved" class="card-list show-love">
        {% for r in (data.top_loved or []) %}
          <div class="card">
            <span class="avatar heart">‚ù§</span>
            <div class="text clamp2">{{ r.text }}</div>
            <div class="meta">
              <span class="chip chip-love">love {{ r.react }}</span>
              <button class="btn-xxs" data-reply="{{ r.text|e }}" onclick="openReplyModal(this)">Reply</button>
            </div>
          </div>
        {% else %}
          <div class="empty inset">No items for current filters.</div>
        {% endfor %}
      </div>
    </div>

    <!-- Top ‚ÄúHaha‚Äù -->
    <div class="block">
      <div class="block-head">
        <h3>Top ‚ÄúHaha‚Äù</h3>
        <div class="sorts">
          <button class="chip sort on" data-target="#list-haha" data-show="haha">Haha</button>
        </div>
      </div>
      <div id="list-haha" class="card-list show-haha">
        {% for r in (data.top_haha or []) %}
          <div class="card">
            <span class="avatar laugh">üòÜ</span>
            <div class="text clamp2">{{ r.text }}</div>
            <div class="meta">
              <span class="chip chip-haha">haha {{ r.react }}</span>
              <button class="btn-xxs" data-reply="{{ r.text|e }}" onclick="openReplyModal(this)">Reply</button>
            </div>
          </div>
        {% else %}
          <div class="empty inset">No items for current filters.</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Filters + Table -->
  <div class="filter-row">
    <input id="tcq" class="search" placeholder="Search comments‚Ä¶" oninput="tcApplyFilters()"/>
    <div class="chips">
      <button class="chip" data-f="pos" onclick="toggleFilter(this)">Positives</button>
      <button class="chip" data-f="neg" onclick="toggleFilter(this)">Negatives</button>
      <button class="chip" data-f="q"  onclick="toggleFilter(this)">Questions</button>
      <button class="chip" data-f="hi" onclick="toggleFilter(this)">High-eng ‚â• p75</button>
      <button class="chip" data-f="bn" onclick="toggleFilter(this)">Bangla</button>
      <button class="chip" data-f="en" onclick="toggleFilter(this)">English</button>
      <button class="chip reset" onclick="resetFilters()">Reset</button>
    </div>
  </div>

  <div class="tbl">
    <div class="thead">
      <div>USER</div><div>COMMENT</div><div>SENTIMENT</div><div>EMOTION</div><div>REACTIONS</div><div>ENGAGEMENT</div><div></div>
    </div>
    <div id="tbody">
      {% for r in rows %}
        <div class="tr"
             data-sent="{{ r.sentiment }}"
             data-emo="{{ r.emotion }}"
             data-react="{{ r.total_reactions }}"
             data-eng="{{ r.engagement_score }}"
             data-lang="{{ r.language|default('') }}"
             data-text="{{ (r.comment_text or '')|lower }}">
          <div class="td user">U</div>
          <div class="td cmt">{{ r.comment_text }}</div>
          <div class="td s">{{ r.sentiment }}</div>
          <div class="td e">{{ r.emotion }}</div>
          <div class="td n">{{ r.total_reactions }}</div>
          <div class="td n">{{ r.engagement_score }}</div>
          <div class="td"><button class="btn-xxs" data-reply="{{ r.comment_text|e }}" onclick="openReplyModal(this)">Reply</button></div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Reply modal -->
<div id="replyModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-head">
      <h4>Reply</h4>
      <button class="x" onclick="closeReply()">‚úï</button>
    </div>

    <div class="suggested">
      <div class="slot">
        <button class="chip ghost" onclick="useSuggestion(0)"></button>
        <button class="chip save" title="Save as slot 1" onclick="saveSlot(0)">üíæ</button>
      </div>
      <div class="slot">
        <button class="chip ghost" onclick="useSuggestion(1)"></button>
        <button class="chip save" title="Save as slot 2" onclick="saveSlot(1)">üíæ</button>
      </div>
      <div class="slot">
        <button class="chip ghost" onclick="useSuggestion(2)"></button>
        <button class="chip save" title="Save as slot 3" onclick="saveSlot(2)">üíæ</button>
      </div>
    </div>

    <textarea id="replyBox" rows="6"></textarea>

    <div class="modal-foot">
      <button class="btn ghost" onclick="copyReply()">Copy</button>
      <a class="btn ghost" href="https://www.facebook.com" target="_blank" rel="noopener">Open on Facebook</a>
      <button class="btn ghost" onclick="saveCurrent()">Save current</button>
      <button class="btn primary" onclick="scheduleNow()">Schedule</button>
    </div>
  </div>
</div>

<style>
:root{
  --card:#fff;
  --line:rgba(16,24,40,.08);
  --muted:#7a8396;
  --pill:#f6f8fb;
  --shadow:0 1px 3px rgba(16,24,40,.06);
  --primary:#2563eb;
}

.tc-wrap{max-width:1180px;margin:0 auto;padding:4px 0 36px}
.tc-header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:6px}
.tc-header h1{font-size:24px;margin:0 0 2px}
.tc-header p{margin:0;color:var(--muted)}
.density{display:flex;align-items:center;gap:6px}
.density span{font-size:12px;color:var(--muted)}
.density .chip{padding:3px 8px}

.kpi-row{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:8px 0 10px}
.kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px 10px;box-shadow:var(--shadow)}
.kpi .label{font-size:12px;color:var(--muted)}
.kpi .val{font-size:16px;font-weight:700}

.helper-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px}
.panel{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
.panel-head{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;font-weight:700}
.panel-body{padding:6px 10px 10px}
.badges{display:flex;flex-wrap:wrap;gap:6px}
.mini-list{list-style:none;margin:0;padding:0}
.mini-item{display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px dashed var(--line)}
.mini-item:last-child{border-bottom:0}
.muted{opacity:.6}
.clamp2{-webkit-line-clamp:2;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden}
.empty{color:var(--muted)}
.empty.inset{padding:10px;border-radius:10px;background:var(--pill)}

.four-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0}
.block{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
.block-head{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--line)}
.block-head h3{margin:0;font-size:15px}
.sorts{display:flex;gap:6px}

.card-list{padding:8px 10px}
.card{display:flex;gap:8px;align-items:flex-start;background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin-bottom:6px;transition:transform .06s ease, box-shadow .06s ease}
.card:hover{transform:translateY(-1px);box-shadow:0 2px 6px rgba(16,24,40,.08)}
.text{flex:1;line-height:1.25}
.meta{display:flex;align-items:center;gap:4px;margin-left:auto}

.avatar{flex:0 0 20px;width:20px;height:20px;border-radius:50%;background:#e8eefc;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#3b55d9}
.avatar.heart{background:#fdeff2;color:#e11d48}
.avatar.laugh{background:#fff3e1}

.chip{border:1px solid var(--line);background:#fff;border-radius:999px;font-size:11px;padding:2px 7px}
.chip.ghost{background:var(--pill)}
.chip.save{background:#eef8ee}
.chip.on,.chip.sort.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.chip-react{background:#eef6ff;border:none}
.chip-eng{background:#eefaf3;border:none}
.chip-love{background:#ffeef3;border:none}
.chip-haha{background:#fff5e7;border:none}

/* show exactly one metric per list */
.card-list .chip-react,.card-list .chip-eng,.card-list .chip-time,.card-list .chip-love,.card-list .chip-haha{display:none}
.card-list.show-react .chip-react{display:inline-flex}
.card-list.show-eng   .chip-eng{display:inline-flex}
.card-list.show-time  .chip-time{display:inline-flex}
.card-list.show-love  .chip-love{display:inline-flex}
.card-list.show-haha  .chip-haha{display:inline-flex}

/* buttons */
.btn-xxs{border:1px solid var(--line);background:#fff;border-radius:6px;font-size:11px;padding:2px 6px;height:22px;line-height:18px}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px}
.btn.ghost{background:var(--pill)}
.btn.primary{background:#4f46e5;color:#fff;border-color:#4f46e5}

/* filter bar & table */
.filter-row{display:flex;align-items:center;gap:8px;margin:10px 0}
.search{flex:1;border:1px solid var(--line);border-radius:10px;padding:8px 10px;height:34px}
.chips{display:flex;flex-wrap:wrap;gap:6px}

.tbl{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
.thead,.tr{display:grid;grid-template-columns:90px 1fr 120px 130px 110px 120px 90px;align-items:center;gap:8px}
.thead{padding:8px 10px;font-weight:700;border-bottom:1px solid var(--line);background:#fbfcfe;position:sticky;top:0;z-index:1;font-size:12px}
.tr{padding:6px 10px;border-bottom:1px solid var(--line);font-size:13px;line-height:1.25}
.tr:nth-child(2n){background:#fcfdff}
.td.n{font-variant-numeric:tabular-nums}

/* modal */
.modal{position:fixed;inset:0;background:rgba(16,24,40,.35);display:flex;align-items:center;justify-content:center;z-index:50}
.modal.hidden{display:none}
.modal-card{background:#fff;border:1px solid var(--line);border-radius:12px;min-width:640px;max-width:880px;box-shadow:0 12px 36px rgba(16,24,40,.25)}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
.modal-head h4{margin:0;font-size:17px}
.modal-head .x{background:var(--pill);border:0;border-radius:8px;width:30px;height:30px}
.suggested{display:flex;gap:6px;padding:8px 12px;border-bottom:1px solid var(--line)}
.suggested .slot{display:flex;gap:6px}
#replyBox{width:100%;border:0;outline:0;padding:12px 12px;min-height:140px;font-size:14px}
.modal-foot{display:flex;gap:8px;justify-content:flex-end;padding:8px 12px;border-top:1px solid var(--line)}

/* Cozy (slightly larger) */
.tc-wrap:not(.dense) .card{padding:10px 12px;margin-bottom:8px;border-radius:12px}
.tc-wrap:not(.dense) .meta{gap:6px}
.tc-wrap:not(.dense) .btn-xxs{height:26px;padding:3px 8px;font-size:12px;border-radius:8px}
.tc-wrap:not(.dense) .avatar{width:22px;height:22px;font-size:12px}
.tc-wrap:not(.dense) .kpi{padding:10px 12px}
.tc-wrap:not(.dense) .panel-head{padding:10px 12px}
.tc-wrap:not(.dense) .panel-body{padding:8px 12px}
.tc-wrap:not(.dense) .block-head{padding:10px 12px}
.tc-wrap:not(.dense) .card-list{padding:10px 12px}
.tc-wrap:not(.dense) .search{height:38px;padding:10px 12px}
.tc-wrap:not(.dense) .thead{padding:10px 12px;font-size:13px}
.tc-wrap:not(.dense) .tr{padding:8px 12px;font-size:14px}

/* responsive */
@media (max-width: 980px){
  .kpi-row{grid-template-columns:repeat(3,1fr)}
  .helper-row{grid-template-columns:1fr}
  .four-grid{grid-template-columns:1fr}
  .modal-card{min-width:auto;width:92%}
  .thead,.tr{grid-template-columns:70px 1fr 110px 110px 90px 90px 70px}
}
</style>

<script>
/* density toggle */
const wrap = document.querySelector('.tc-wrap');
document.getElementById('compactBtn').addEventListener('click',()=>{
  wrap.classList.add('dense');
  document.getElementById('compactBtn').classList.add('on');
  document.getElementById('cozyBtn').classList.remove('on');
});
document.getElementById('cozyBtn').addEventListener('click',()=>{
  wrap.classList.remove('dense');
  document.getElementById('cozyBtn').classList.add('on');
  document.getElementById('compactBtn').classList.remove('on');
});

/* sort chips (one visible metric) */
document.querySelectorAll('.chip.sort').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const target = document.querySelector(btn.dataset.target);
    if(!target) return;
    btn.parentElement.querySelectorAll('.chip.sort').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on');
    target.classList.remove('show-react','show-eng','show-time','show-love','show-haha');
    target.classList.add('show-' + btn.dataset.show);
  });
});

/* filters */
const activeFilters = new Set();
function toggleFilter(el){
  const key = el.dataset.f;
  if(activeFilters.has(key)){ activeFilters.delete(key); el.classList.remove('on'); }
  else { activeFilters.add(key); el.classList.add('on'); }
  tcApplyFilters();
}
function resetFilters(){
  activeFilters.clear();
  document.querySelectorAll('.filter-row .chip').forEach(c=>c.classList.remove('on'));
  document.getElementById('tcq').value='';
  tcApplyFilters();
}
function tcApplyFilters(){
  const q = (document.getElementById('tcq').value || '').trim().toLowerCase();
  const rows = document.querySelectorAll('#tbody .tr');
  rows.forEach(r=>{
    const txt = r.dataset.text || '';
    const sent = (r.dataset.sent || '').toLowerCase();
    const lang = (r.dataset.lang || '').toLowerCase();
    let ok = true;
    if(q && !txt.includes(q)) ok = false;
    if(activeFilters.has('pos') && !sent.startsWith('pos')) ok = false;
    if(activeFilters.has('neg') && !sent.startsWith('neg')) ok = false;
    if(activeFilters.has('q') && !/\?/.test(txt)) ok = false;
    if(activeFilters.has('bn') && lang!=='bangla' && lang!=='bn') ok = false;
    if(activeFilters.has('en') && lang!=='english' && lang!=='en') ok = false;
    if(activeFilters.has('hi')){
      const eng = parseInt(r.dataset.eng||'0',10);
      const p75 = {{ hi_p75|round(0) }};
      if(eng < p75) ok=false;
    }
    r.style.display = ok ? 'grid' : 'none';
  });
}

/* reply modal & suggestions */
const defaultSuggestions = [
  "Thanks for sharing your thoughts.",
  "We hear you ‚Äî could you DM us a few more details?",
  "Great point! Passing this to the team."
];
let suggestions = [...defaultSuggestions];
const modal = document.getElementById('replyModal');
const replyBox = document.getElementById('replyBox');

function hydrateSuggestionButtons(){
  document.querySelectorAll('.suggested .slot .chip.ghost').forEach((b, i)=>{
    b.textContent = suggestions[i] || defaultSuggestions[i];
  });
}
hydrateSuggestionButtons();

function openReplyModal(btn){
  replyBox.value = btn.dataset.reply || '';
  hydrateSuggestionButtons();
  modal.classList.remove('hidden');
}
function closeReply(){ modal.classList.add('hidden'); }
function useSuggestion(i){
  replyBox.value = suggestions[i] || defaultSuggestions[i];
  replyBox.focus();
}
async function saveSlot(i){
  const body = replyBox.value.trim();
  if(!body) return;
  suggestions[i] = body; hydrateSuggestionButtons();
  try{
    await fetch('/api/replies', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({label:`Slot ${i+1}`, body})
    });
  }catch(e){}
}
async function saveCurrent(){
  const body = replyBox.value.trim();
  if(!body) return;
  try{
    await fetch('/api/replies', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({label:'Saved reply', body})
    });
  }catch(e){}
}
function copyReply(){ navigator.clipboard.writeText(replyBox.value || ''); }
async function scheduleNow(){
  const postId = "{{ post_id }}";
  const body = replyBox.value.trim();
  if(!body) return;
  await fetch('/api/schedule_reply', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ post_id: postId, reply: body, scheduled_at: "" })
  });
  closeReply();
}
</script>
